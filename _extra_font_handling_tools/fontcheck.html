<!DOCTYPE html>
<html lang="ru">
<meta charset="UTF-8">
<title>Font Probe — папка → рендер</title>
<style>
  body { font: 14px system-ui, sans-serif; margin: 16px; }
  #controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  input[type="text"] { width: 520px; }
  #log { white-space: pre; background:#f5f5f5; padding:8px; max-height:200px; overflow:auto; }
</style>
<body>
  <div id="controls">
    <input id="picker" type="file" webkitdirectory multiple accept=".woff2,.woff,.ttf" />
    <label>Текст: <input id="sample" type="text" value="ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz 0123456789 Привет мир" /></label>
    <label>Размер: <input id="size" type="number" value="20" min="8" max="96" step="1"> px</label>
    <button id="run">Рендер</button>
    <span id="count"></span>
  </div>
  <canvas id="c" width="1600" height="200"></canvas>
  <div id="log"></div>

<script>
(() => {
  const picker = document.getElementById('picker');
  const runBtn = document.getElementById('run');
  const sampleEl = document.getElementById('sample');
  const sizeEl = document.getElementById('size');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const logEl = document.getElementById('log');
  const countEl = document.getElementById('count');

  const log = (...a) => { logEl.textContent += a.join(' ') + '\n'; };
  const clearLog = () => { logEl.textContent = ''; };

  function filterAndSortFiles(fileList) {
    const exts = /\.(woff2|woff|ttf)$/i;
    return Array.from(fileList)
      .filter(f => exts.test(f.name))
      .sort((a,b) => a.name.localeCompare(b.name, 'en'));
  }

  async function renderAll(files) {
    clearLog();
    if (!files.length) { log('Файлов нет.'); return; }
    const sample = sampleEl.value || 'Sample';
    const fontPx = Math.max(8, Math.min(96, parseInt(sizeEl.value || '20', 10)));
    const lineH = Math.round(fontPx * 1.6);
    const leftPad = 10;

    // Подготовим холст динамически под количество строк
    const neededH = lineH * files.length + 20;
    canvas.height = neededH;
    canvas.width  = Math.max(1600, (sample.length + 40) * Math.ceil(fontPx * 0.8));
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#000';
    ctx.textBaseline = 'top';

    let y = 10;
    let ok = 0, fail = 0;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const url = URL.createObjectURL(file);
      const family = `__TEST__${i}__${file.name.replace(/\.(woff2|woff|ttf)$/i,'')}`;

      try {
        const ff = new FontFace(family, `url(${url})`);
        const loaded = await ff.load();
        document.fonts.add(loaded);

        ctx.font = `${fontPx}px "${family}", sans-serif`;
        const label = `${file.name} → `;
        // подпись файла рисуем системным шрифтом, чтобы её точно прочитать
        ctx.save();
        ctx.font = `12px system-ui, sans-serif`;
        ctx.fillText(file.name + ' →', leftPad, y);
        ctx.restore();

        // текст проверочный — шрифтом из файла
        ctx.fillText(`  ${sample}`, leftPad + ctx.measureText(label).width, y);

        ok++;
        log(`OK   ${file.name}`);
      } catch (e) {
        // Если шрифт не загрузился — фиксируем
        ctx.save();
        ctx.font = `12px system-ui, sans-serif`;
        ctx.fillStyle = '#b00';
        ctx.fillText(`${file.name} → [ошибка загрузки шрифта]`, leftPad, y);
        ctx.restore();

        fail++;
        log(`FAIL ${file.name} :: ${e && e.message ? e.message : e}`);
      } finally {
        URL.revokeObjectURL(url);
        y += lineH;
      }
    }

    countEl.textContent = `Отрисовано: ${ok} | Ошибок: ${fail} | Всего: ${files.length}`;
  }

  let selectedFiles = [];
  picker.addEventListener('change', () => {
    selectedFiles = filterAndSortFiles(picker.files);
    countEl.textContent = `Выбрано файлов: ${selectedFiles.length}`;
    clearLog();
  });

  runBtn.addEventListener('click', () => {
    if (!selectedFiles.length) {
      selectedFiles = filterAndSortFiles(picker.files);
    }
    renderAll(selectedFiles);
  });
})();
</script>
</body>
</html>
